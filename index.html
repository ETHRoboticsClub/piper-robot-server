<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>VR Teleoperation Control</title>
    <meta name="description" content="VR Teleoperation System with dual-arm robot control">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script src="app.js" defer></script>
    <style>
      /* Base styles */
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
        overflow-x: hidden;
      }

      /* Desktop-only interface */
      .desktop-interface {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 10000;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .desktop-header {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        margin-bottom: 20px;
        max-width: 800px;
      }

      .desktop-title {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 10px;
      }

      .desktop-subtitle {
        font-size: 14px;
        color: #7f8c8d;
        margin-bottom: 20px;
      }

      /* Status indicators */
      .status-section {
        margin-bottom: 2rem;
      }

      .status-section h2 {
        color: #333;
        margin-bottom: 1rem;
        font-size: 1.2rem;
      }

      .status-grid {
        display: flex;
        gap: 1.5rem;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
      }

      .status-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
      }

      .status-indicator {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: #ff4444;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
      }

      .status-indicator.connected {
        background-color: #44ff44;
      }

      .status-label {
        font-size: 14px;
        font-weight: 500;
      }

      /* Control toggles */
      .control-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid #3498db;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
      }

      .control-toggle:hover {
        background: #3498db;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
      }

      .control-toggle.active {
        background: #27ae60;
        border-color: #27ae60;
        color: white;
      }

      /* Keyboard help section */
      .keyboard-help {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .keyboard-help.active {
        background: rgba(76, 175, 80, 0.1);
        border: 2px solid #4CAF50;
        box-shadow: 0 4px 20px rgba(76, 175, 80, 0.3);
      }

      .keyboard-help.active .help-title {
        color: #2E7D32;
      }

      .keyboard-help-header {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }

      .keyboard-help-expanded {
        display: none;
      }

      .keyboard-help.active .keyboard-help-expanded {
        display: block;
      }

      .keyboard-help-collapsed {
        display: block;
      }

      .keyboard-help-collapsed .control-toggle {
        display: inline-flex;
        width: auto;
      }

      .keyboard-help.active .keyboard-help-collapsed {
        display: none;
      }

      .help-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .help-columns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .help-column h4 {
        margin: 0 0 10px 0;
        color: #34495e;
        font-size: 16px;
        border-bottom: 2px solid #3498db;
        padding-bottom: 5px;
      }

      .key-group {
        margin-bottom: 12px;
      }

      .key-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
      }

      .key {
        background: #ecf0f1;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
        font-size: 12px;
        font-weight: bold;
        color: #2c3e50;
      }

      .key-desc {
        color: #7f8c8d;
        font-size: 13px;
      }

      /* VR-only content */
      .vr-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 9999;
        background: rgba(255, 255, 255, 0.95);
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
      }

      .vr-title {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #2c3e50;
      }

      .vr-subtitle {
        font-size: 16px;
        color: #7f8c8d;
        margin-bottom: 30px;
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .desktop-interface {
          padding: 15px 10px;
        }
        
        .desktop-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
        }
        
        .status-section {
          flex-direction: column;
          align-items: flex-start;
          gap: 15px;
        }
        
        .help-columns {
          grid-template-columns: 1fr;
        }
      }

      /* Hide desktop interface in VR */
      @media (display-mode: standalone) {
        .desktop-interface {
          display: none;
        }
      }

      /* A-Frame scene styling */
      a-scene {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 1;
      }

      .robot-controls {
        text-align: center;
        margin-bottom: 1.5rem;
      }

      .engage-btn {
        background: linear-gradient(45deg, #4CAF50, #45a049);
        border: none;
        color: white;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 0.5rem;
        min-width: 160px;
      }

      .engage-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }

      .engage-btn.disconnect {
        background: linear-gradient(45deg, #f44336, #d32f2f);
      }

      .engagement-status {
        font-size: 14px;
        color: #666;
        font-style: italic;
      }

      .control-section {
        margin-top: 1rem;
      }

      /* Settings button */
      .settings-button {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10001;
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .settings-button:hover {
        background: #3498db;
        color: white;
        transform: rotate(45deg);
        box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
      }

      /* Settings modal */
      .settings-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.7);
        z-index: 20000;
        display: none;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
      }

      .settings-modal.show {
        display: flex;
      }

      .settings-content {
        background: white;
        border-radius: 15px;
        padding: 30px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        border-bottom: 2px solid #ecf0f1;
        padding-bottom: 15px;
      }

      .settings-title {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
      }

      .close-button {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #7f8c8d;
        padding: 5px;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .close-button:hover {
        background: #e74c3c;
        color: white;
      }

      .settings-section {
        margin-bottom: 25px;
      }

      .settings-section h3 {
        color: #34495e;
        margin-bottom: 15px;
        font-size: 18px;
        border-left: 4px solid #3498db;
        padding-left: 10px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #2c3e50;
      }

      .form-group input {
        width: 100%;
        padding: 8px 12px;
        border: 2px solid #bdc3c7;
        border-radius: 5px;
        font-size: 14px;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
      }

      .form-group input:focus {
        outline: none;
        border-color: #3498db;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .button-row {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
      }

      .save-button {
        background: linear-gradient(45deg, #27ae60, #2ecc71);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 48%;
      }

      .save-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
      }

      .save-button:disabled {
        background: #95a5a6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .restart-button {
        background: linear-gradient(45deg, #f44336, #d32f2f);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 48%;
      }

      .restart-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
      }
    </style>
  </head>
  <body>
    <!-- Settings Button -->
    <div class="settings-button" onclick="openSettings()">
      ‚öôÔ∏è
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
      <div class="settings-content">
        <div class="settings-header">
          <div class="settings-title">System Configuration</div>
          <button class="close-button" onclick="closeSettings()">√ó</button>
        </div>
        
        <form id="settingsForm">
          <div class="settings-section">
            <h3>ü§ñ Robot Arms</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="leftArmName">Left Arm Name</label>
                <input type="text" id="leftArmName" name="leftArmName">
              </div>
              <div class="form-group">
                <label for="leftArmPort">Left Arm Port</label>
                <input type="text" id="leftArmPort" name="leftArmPort" placeholder="/dev/ttySO100red">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="rightArmName">Right Arm Name</label>
                <input type="text" id="rightArmName" name="rightArmName">
              </div>
              <div class="form-group">
                <label for="rightArmPort">Right Arm Port</label>
                <input type="text" id="rightArmPort" name="rightArmPort" placeholder="/dev/ttySO100blue">
              </div>
            </div>
          </div>

          <div class="settings-section">
            <h3>üåê Network Settings</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="httpsPort">HTTPS Port</label>
                <input type="number" id="httpsPort" name="httpsPort" min="1024" max="65535">
              </div>
              <div class="form-group">
                <label for="websocketPort">WebSocket Port</label>
                <input type="number" id="websocketPort" name="websocketPort" min="1024" max="65535">
              </div>
            </div>
            <div class="form-group">
              <label for="hostIp">Host IP Address</label>
              <input type="text" id="hostIp" name="hostIp" placeholder="0.0.0.0">
            </div>
          </div>

          <div class="settings-section">
            <h3>üéÆ Control Parameters</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="vrScale">VR Scale Factor</label>
                <input type="number" id="vrScale" name="vrScale" step="0.1" min="0.1" max="5.0">
              </div>
              <div class="form-group">
                <label for="sendInterval">Send Interval (ms)</label>
                <input type="number" id="sendInterval" name="sendInterval" step="1" min="10" max="200">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="posStep">Position Step (m)</label>
                <input type="number" id="posStep" name="posStep" step="0.001" min="0.001" max="0.1">
              </div>
              <div class="form-group">
                <label for="angleStep">Angle Step (degrees)</label>
                <input type="number" id="angleStep" name="angleStep" step="0.5" min="0.5" max="45">
              </div>
            </div>
          </div>

          <div class="button-row">
            <button type="submit" class="save-button" id="saveButton">
              üíæ Save Configuration
            </button>
            <button type="button" class="restart-button" id="restartButton" onclick="restartSystem()">
              üîÑ Restart System
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Desktop Interface -->
    <div class="desktop-interface" id="desktopInterface">
      <div class="desktop-header">
        <div class="desktop-title">VR Teleoperation System</div>
        <div class="desktop-subtitle">Dual-arm robot control via VR controllers</div>
        
        <div class="status-section">
          <h2>ü§ñ Robot Status</h2>
          <div class="status-grid">
            <div class="status-item">
              <div class="status-indicator" id="leftArmStatus"></div>
              <span>Left Arm</span>
            </div>
            <div class="status-item">
              <div class="status-indicator" id="rightArmStatus"></div>
              <span>Right Arm</span>
            </div>
            <div class="status-item">
              <div class="status-indicator" id="vrStatus"></div>
              <span>VR Connected</span>
            </div>
          </div>
          
          <!-- Robot Engagement Controls -->
          <div class="robot-controls">
            <button id="robotEngageBtn" class="engage-btn" onclick="toggleRobotEngagement()">
              <span id="engageBtnText">üîå Connect Robot</span>
            </button>
            <div class="engagement-status">
              <span id="engagementStatusText">Motors Disengaged</span>
            </div>
          </div>
        </div>
      </div>

      <div class="keyboard-help">
        <!-- Collapsed state: just the enable button -->
        <div class="keyboard-help-collapsed">
          <div class="control-toggle" id="keyboardToggle" onclick="toggleKeyboardControl()">
            <span>üéÆ</span>
            <span id="keyboardToggleText">Enable Keyboard Control</span>
          </div>
        </div>
        
        <!-- Expanded state: title, disable button, and content -->
        <div class="keyboard-help-expanded">
          <div class="keyboard-help-header">
            <div class="control-toggle active" onclick="toggleKeyboardControl()">
              <span>üéÆ</span>
              <span>Disable Keyboard Control</span>
            </div>
            <div class="help-title">
              <span>‚å®Ô∏è</span>
              Keyboard Controls
            </div>
          </div>
          
          <div class="help-columns">
            <div class="help-column">
              <h4>Left Arm</h4>
              <div class="key-group">
                <div class="key-row">
                  <span><kbd class="key">W</kbd> / <kbd class="key">S</kbd></span>
                  <span class="key-desc">Forward / Backward</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">A</kbd> / <kbd class="key">D</kbd></span>
                  <span class="key-desc">Left / Right</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">Q</kbd> / <kbd class="key">E</kbd></span>
                  <span class="key-desc">Down / Up</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">Z</kbd> / <kbd class="key">X</kbd></span>
                  <span class="key-desc">Wrist Roll</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">F</kbd></span>
                  <span class="key-desc">Toggle Gripper</span>
                </div>
              </div>
            </div>
            
            <div class="help-column">
              <h4>Right Arm</h4>
              <div class="key-group">
                <div class="key-row">
                  <span><kbd class="key">I</kbd> / <kbd class="key">K</kbd></span>
                  <span class="key-desc">Forward / Backward</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">J</kbd> / <kbd class="key">L</kbd></span>
                  <span class="key-desc">Left / Right</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">U</kbd> / <kbd class="key">O</kbd></span>
                  <span class="key-desc">Up / Down</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">N</kbd> / <kbd class="key">M</kbd></span>
                  <span class="key-desc">Wrist Roll</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">;</kbd></span>
                  <span class="key-desc">Toggle Gripper</span>
                </div>
              </div>
            </div>
          </div>
          
          <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #bdc3c7; color: #7f8c8d; font-size: 13px;">
            <strong>Tips:</strong> Position control activates automatically when you press movement keys. 
            Use <kbd class="key">ESC</kbd> to stop the system.
          </div>
        </div>
      </div>
    </div>

    <!-- VR-only content -->
    <div class="vr-content" id="vrContent">
      <div class="vr-title">VR Teleoperation</div>
    </div>

    <!-- A-Frame VR Scene -->
    <a-scene vr-mode-ui="enabled: true;">
      <!-- Passthrough setup -->
      <a-entity webxr-passthrough="referenceSpaceType: local-floor"></a-entity>

      <!-- Controllers -->
      <a-entity id="leftHand" oculus-touch-controls="hand: left">
        <a-text id="leftHandInfo" value="Pos: ...\nRot: ..." position="0 0.04 -0.05" rotation="0 0 0" scale="0.05 0.05 0.05" color="white" align="center"></a-text>
      </a-entity>
      <a-entity id="rightHand" oculus-touch-controls="hand: right">
        <a-text id="rightHandInfo" value="Pos: ...\nRot: ..." position="0 0.04 -0.05" rotation="0 0 0" scale="0.05 0.05 0.05" color="white" align="center"></a-text>
      </a-entity>
    </a-scene>

    <script>
      // Global state
      let isKeyboardEnabled = false;
      let isRobotEngaged = false;
      let currentConfig = {};

      // Settings modal functions
      function openSettings() {
        const modal = document.getElementById('settingsModal');
        modal.classList.add('show');
        loadConfiguration();
      }

      function closeSettings() {
        const modal = document.getElementById('settingsModal');
        modal.classList.remove('show');
      }

      function loadConfiguration() {
        fetch('/api/config')
          .then(response => response.json())
          .then(config => {
            currentConfig = config;
            populateSettingsForm(config);
          })
          .catch(error => {
            console.error('Error loading configuration:', error);
            alert('Error loading configuration');
          });
      }

      function populateSettingsForm(config) {
        // Robot arms
        document.getElementById('leftArmName').value = config.robot?.left_arm?.name || '';
        document.getElementById('leftArmPort').value = config.robot?.left_arm?.port || '';
        document.getElementById('rightArmName').value = config.robot?.right_arm?.name || '';
        document.getElementById('rightArmPort').value = config.robot?.right_arm?.port || '';
        
        // Network settings
        document.getElementById('httpsPort').value = config.network?.https_port || '';
        document.getElementById('websocketPort').value = config.network?.websocket_port || '';
        document.getElementById('hostIp').value = config.network?.host_ip || '';
        
        // Control parameters
        document.getElementById('vrScale').value = config.robot?.vr_to_robot_scale || '';
        document.getElementById('sendInterval').value = (config.robot?.send_interval * 1000) || ''; // Convert to ms
        document.getElementById('posStep').value = config.control?.keyboard?.pos_step || '';
        document.getElementById('angleStep').value = config.control?.keyboard?.angle_step || '';
      }

      function restartSystem() {
        if (!confirm('Are you sure you want to restart the system? This will temporarily disconnect all devices.')) {
          return;
        }

        const restartButton = document.getElementById('restartButton');
        restartButton.disabled = true;
        restartButton.textContent = 'Restarting...';

        fetch('/api/restart', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          if (response.ok) {
            // Show restart message and close modal
            alert('System is restarting... The page will reload automatically in a few seconds.');
            closeSettings();
            
            // Try to reconnect after a delay
            setTimeout(() => {
              window.location.reload();
            }, 5000);
          } else {
            alert('Failed to restart system. Please restart manually.');
          }
        })
        .catch(error => {
          console.error('Error restarting system:', error);
          alert('Error communicating with server. Please restart manually.');
        })
        .finally(() => {
          restartButton.disabled = false;
          restartButton.textContent = 'üîÑ Restart System';
        });
      }

      function saveConfiguration() {
        const form = document.getElementById('settingsForm');
        const formData = new FormData(form);
        
        // Build config object
        const updatedConfig = {
          robot: {
            left_arm: {
              name: formData.get('leftArmName'),
              port: formData.get('leftArmPort'),
              enabled: true
            },
            right_arm: {
              name: formData.get('rightArmName'),
              port: formData.get('rightArmPort'),
              enabled: true
            },
            vr_to_robot_scale: parseFloat(formData.get('vrScale')),
            send_interval: parseFloat(formData.get('sendInterval')) / 1000 // Convert from ms
          },
          network: {
            https_port: parseInt(formData.get('httpsPort')),
            websocket_port: parseInt(formData.get('websocketPort')),
            host_ip: formData.get('hostIp')
          },
          control: {
            keyboard: {
              pos_step: parseFloat(formData.get('posStep')),
              angle_step: parseFloat(formData.get('angleStep'))
            }
          }
        };

        const saveButton = document.getElementById('saveButton');
        saveButton.disabled = true;
        saveButton.textContent = 'Saving...';

        fetch('/api/config', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(updatedConfig)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Configuration saved successfully! Use the restart button to apply changes.');
          } else {
            alert('Failed to save configuration: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error saving configuration:', error);
          alert('Error saving configuration');
        })
        .finally(() => {
          saveButton.disabled = false;
          saveButton.textContent = 'üíæ Save Configuration';
        });
      }

      // Update status indicators
      function updateStatus() {
        fetch('/api/status')
          .then(response => response.json())
          .then(data => {
            // Update arm connection indicators (based on device files)
            const leftIndicator = document.getElementById('leftArmStatus');
            const rightIndicator = document.getElementById('rightArmStatus');
            const vrIndicator = document.getElementById('vrStatus');
            
            leftIndicator.className = 'status-indicator' + (data.left_arm_connected ? ' connected' : '');
            rightIndicator.className = 'status-indicator' + (data.right_arm_connected ? ' connected' : '');
            vrIndicator.className = 'status-indicator' + (data.vrConnected ? ' connected' : '');
            
            // Update keyboard control status
            isKeyboardEnabled = data.keyboardEnabled;
            const keyboardHelp = document.querySelector('.keyboard-help');
            
            if (isKeyboardEnabled) {
              if (keyboardHelp) keyboardHelp.classList.add('active');
            } else {
              if (keyboardHelp) keyboardHelp.classList.remove('active');
            }
            
            // Update robot engagement status
            if (data.robotEngaged !== undefined) {
              isRobotEngaged = data.robotEngaged;
              updateEngagementUI();
            }
          })
          .catch(error => {
            console.error('Error fetching status:', error);
          });
      }

      function updateEngagementUI() {
        const engageBtn = document.getElementById('robotEngageBtn');
        const engageBtnText = document.getElementById('engageBtnText');
        const engagementStatusText = document.getElementById('engagementStatusText');
        
        if (isRobotEngaged) {
          engageBtn.classList.add('disconnect');
          engageBtnText.textContent = 'üîå Disconnect Robot';
          engagementStatusText.textContent = 'Motors Engaged';
          engagementStatusText.style.color = '#4CAF50';
        } else {
          engageBtn.classList.remove('disconnect');
          engageBtnText.textContent = 'üîå Connect Robot';
          engagementStatusText.textContent = 'Motors Disengaged';
          engagementStatusText.style.color = '#666';
        }
      }

      function toggleRobotEngagement() {
        const action = isRobotEngaged ? 'disconnect' : 'connect';
        
        fetch('/api/robot', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action: action })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            isRobotEngaged = !isRobotEngaged;
            updateEngagementUI();
          } else {
            alert('Failed to ' + action + ' robot: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error toggling robot engagement:', error);
          alert('Error communicating with server');
        });
      }

      // Toggle keyboard control
      function toggleKeyboardControl() {
        const action = isKeyboardEnabled ? 'disable' : 'enable';
        
        fetch('/api/keyboard', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action: action })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            isKeyboardEnabled = !isKeyboardEnabled;
            const keyboardHelp = document.querySelector('.keyboard-help');
            
            if (isKeyboardEnabled) {
              if (keyboardHelp) keyboardHelp.classList.add('active');
            } else {
              if (keyboardHelp) keyboardHelp.classList.remove('active');
            }
          } else {
            alert('Failed to toggle keyboard control: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error toggling keyboard control:', error);
          alert('Error communicating with server');
        });
      }

      // Check if running in VR/AR mode
      function isVRMode() {
        return window.navigator.xr && document.fullscreenElement;
      }

      // Update UI based on device
      function updateUIForDevice() {
        const desktopInterface = document.getElementById('desktopInterface');
        const vrContent = document.getElementById('vrContent');
        
        if (isVRMode()) {
          desktopInterface.style.display = 'none';
          vrContent.style.display = 'none';
        } else {
          // Check if this is a VR-capable device
          if (navigator.xr) {
            navigator.xr.isSessionSupported('immersive-vr').then((supported) => {
              if (supported) {
                // VR-capable device - show VR interface
                desktopInterface.style.display = 'none';
                vrContent.style.display = 'block';
              } else {
                // Not VR-capable - show desktop interface
                desktopInterface.style.display = 'block';
                vrContent.style.display = 'none';
              }
            }).catch(() => {
              // Fallback to desktop interface if XR check fails
              desktopInterface.style.display = 'block';
              vrContent.style.display = 'none';
            });
          } else {
            // No XR support - show desktop interface
            desktopInterface.style.display = 'block';
            vrContent.style.display = 'none';
          }
        }
      }

      // Initialize
      document.addEventListener('DOMContentLoaded', () => {
        updateUIForDevice();
        
        // Start status monitoring
        updateStatus();
        setInterval(updateStatus, 2000); // Update every 2 seconds
        
        // Handle VR mode changes
        document.addEventListener('fullscreenchange', updateUIForDevice);
        
        // VR session detection
        if (navigator.xr) {
          navigator.xr.addEventListener('sessionstart', () => {
            updateStatus();
            updateUIForDevice();
          });
          
          navigator.xr.addEventListener('sessionend', () => {
            updateStatus();
            updateUIForDevice();
          });
        }

        // Settings form handler
        document.getElementById('settingsForm').addEventListener('submit', (e) => {
          e.preventDefault();
          saveConfiguration();
        });

        // Close modal when clicking outside
        document.getElementById('settingsModal').addEventListener('click', (e) => {
          if (e.target.id === 'settingsModal') {
            closeSettings();
          }
        });
      });

      // Handle window resize
      window.addEventListener('resize', updateUIForDevice);

      // Web-based keyboard control
      let pressedKeys = new Set();

      // Add keyboard event listeners for web-based control
      document.addEventListener('keydown', handleKeyDown);
      document.addEventListener('keyup', handleKeyUp);

      function handleKeyDown(event) {
        // Only handle keys if keyboard control is enabled and we're focused on the page
        if (!isKeyboardEnabled || pressedKeys.has(event.code)) return;
        
        // Prevent default browser behavior for our control keys
        if (isControlKey(event.code)) {
          event.preventDefault();
          pressedKeys.add(event.code);
          sendKeyCommand(event.code, 'press');
        }
      }

      function handleKeyUp(event) {
        // Only handle keys if keyboard control is enabled
        if (!isKeyboardEnabled || !pressedKeys.has(event.code)) return;
        
        if (isControlKey(event.code)) {
          event.preventDefault();
          pressedKeys.delete(event.code);
          sendKeyCommand(event.code, 'release');
        }
      }

      function isControlKey(code) {
        // Check if this is one of our robot control keys
        const controlKeys = [
          // Left arm
          'KeyW', 'KeyS', 'KeyA', 'KeyD', 'KeyQ', 'KeyE', 
          'KeyZ', 'KeyX', 'KeyF',
          // Right arm
          'KeyI', 'KeyK', 'KeyJ', 'KeyL', 'KeyU', 'KeyO',
          'KeyN', 'KeyM', 'Semicolon',
          // Global
          'Escape'
        ];
        return controlKeys.includes(code);
      }

      function sendKeyCommand(keyCode, action) {
        // Convert browser keyCode to our key mapping
        const keyMap = {
          // Left arm
          'KeyW': 'w', 'KeyS': 's', 'KeyA': 'a', 'KeyD': 'd',
          'KeyQ': 'q', 'KeyE': 'e', 'KeyZ': 'z', 'KeyX': 'x',
          'KeyF': 'f',
          // Right arm  
          'KeyI': 'i', 'KeyK': 'k', 'KeyJ': 'j', 'KeyL': 'l',
          'KeyU': 'u', 'KeyO': 'o', 'KeyN': 'n', 'KeyM': 'm',
          'Semicolon': ';',
          // Global
          'Escape': 'esc'
        };

        const key = keyMap[keyCode];
        if (!key) return;

        fetch('/api/keypress', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            key: key, 
            action: action 
          })
        })
        .catch(error => {
          console.error('Error sending key command:', error);
        });
      }
    </script>
  </body>
</html> 