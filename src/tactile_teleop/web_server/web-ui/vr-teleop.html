<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Tactile Robotics - VR Remote Teleoperation</title>
    <meta
      name="description"
      content="Tactile Robotics - VR Remote Teleoperation Experience"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- A-Frame and VR scripts will be loaded dynamically after VR button is clicked -->
    <script>
      // VR Teleop page initialization
      document.addEventListener('DOMContentLoaded', async function () {
        // Update VR server URL dynamically
        const vrUrlElement = document.getElementById('vrServerUrl');
        if (vrUrlElement) {
          const currentUrl = window.location.href;
          vrUrlElement.textContent = currentUrl;
        }

        // Check for VR support and conditionally load start-vr.js
        if (navigator.xr) {
          try {
            // Test both AR and VR session types
            console.log('Testing VR session support...');
            const isARSupported = await navigator.xr.isSessionSupported(
              'immersive-ar',
            );
            const isVRSupported = await navigator.xr.isSessionSupported(
              'immersive-vr',
            );

            console.log('AR support:', isARSupported);
            console.log('VR support:', isVRSupported);

            const hasVRSupport = isARSupported || isVRSupported;
            if (hasVRSupport) {
              console.log(
                'VR device detected, creating VR button immediately...',
              );

              // Create VR start button immediately (don't wait for start-vr.js)
              const startButton = document.createElement('button');
              startButton.id = 'immediate-vr-button';
              startButton.textContent = 'Start VR Experience';

              // Style the button
              Object.assign(startButton.style, {
                position: 'fixed',
                top: '50%',
                left: '50%',
                transform: 'translate(-50%, -50%)',
                padding: '20px 40px',
                fontSize: '24px',
                fontWeight: 'bold',
                backgroundColor: '#4CAF50',
                color: 'white',
                border: 'none',
                borderRadius: '12px',
                cursor: 'pointer',
                zIndex: '10000',
                boxShadow: '0 8px 20px rgba(76, 175, 80, 0.4)',
                transition: 'all 0.3s ease',
                fontFamily:
                  '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
              });

              // Add hover effects
              startButton.addEventListener('mouseenter', () => {
                startButton.style.backgroundColor = '#45a049';
                startButton.style.transform =
                  'translate(-50%, -50%) scale(1.05)';
              });

              startButton.addEventListener('mouseleave', () => {
                startButton.style.backgroundColor = '#4CAF50';
                startButton.style.transform = 'translate(-50%, -50%) scale(1)';
              });

              // Add click handler for VR activation
              startButton.addEventListener('click', async () => {
                console.log(
                  'VR button clicked, loading A-Frame and VR environment...',
                );

                try {
                  // Change button text to show loading
                  startButton.textContent = 'Loading VR Environment...';
                  startButton.style.backgroundColor = '#ff9800';

                  // Load A-Frame dynamically
                  await loadAFrame();
                  console.log('A-Frame loaded successfully');

                  // Load VR-related scripts
                  await loadVRScripts();
                  console.log('VR scripts loaded successfully');

                  // Create A-Frame scene
                  createAFrameScene();
                  console.log('A-Frame scene created');

                  // Wait for scene to be ready
                  const sceneEl = document.querySelector('a-scene');
                  await waitForSceneReady(sceneEl);
                  console.log('A-Frame scene ready');

                  // Hide button and enter VR
                  startButton.style.display = 'none';
                  await sceneEl.enterVR(true);
                  console.log('VR mode activated successfully');
                } catch (error) {
                  console.error('Failed to start VR:', error);
                  alert(`Failed to start VR: ${error.message}`);

                  // Restore button
                  startButton.textContent = 'Start VR Experience';
                  startButton.style.backgroundColor = '#4CAF50';
                  startButton.style.display = 'block';
                }
              });

              document.body.appendChild(startButton);
              console.log('VR button created and added to page');

              // Hide desktop interface for VR users
              const desktopInterface =
                document.getElementById('desktopInterface');
              if (desktopInterface) {
                desktopInterface.style.display = 'none';
              }

              // Still load start-vr.js for additional functionality (optional enhancement)
              const script = document.createElement('script');
              script.src = 'start-vr.js';
              script.defer = true;
              script.onload = () =>
                console.log('start-vr.js loaded (for future enhancements)');
              script.onerror = () =>
                console.log('start-vr.js failed to load (not critical)');
              document.head.appendChild(script);
            } else {
              console.log('Not a VR device, showing desktop interface');
              // Show desktop interface for non-VR users
              const desktopInterface =
                document.getElementById('desktopInterface');
              if (desktopInterface) {
                desktopInterface.style.display = 'block';
              }
            }
          } catch (error) {
            console.error('Error checking VR support:', error);
            // Fallback to desktop interface
            const desktopInterface =
              document.getElementById('desktopInterface');
            if (desktopInterface) {
              desktopInterface.style.display = 'block';
            }
          }
        } else {
          console.log('WebXR not available, showing desktop interface');
          // Show desktop interface for non-WebXR browsers
          const desktopInterface = document.getElementById('desktopInterface');
          if (desktopInterface) {
            desktopInterface.style.display = 'block';
          }
        }

        // Helper functions for dynamic A-Frame loading

        function loadAFrame() {
          return new Promise((resolve, reject) => {
            if (window.AFRAME) {
              resolve();
              return;
            }

            const script = document.createElement('script');
            script.src = 'https://aframe.io/releases/1.7.1/aframe.min.js';
            script.onload = () => resolve();
            script.onerror = () => reject(new Error('Failed to load A-Frame'));
            document.head.appendChild(script);
          });
        }

        function loadVRScripts() {
          return Promise.all([
            loadScript(
              'https://unpkg.com/livekit-client@latest/dist/livekit-client.umd.js',
            ),
            loadScript('livekit-utils.js'),
            loadScript('controllers.js'),
            loadScript('video-stream.js'),
          ]);
        }

        function loadScript(src) {
          return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            script.onload = () => resolve();
            script.onerror = () => reject(new Error(`Failed to load ${src}`));
            document.head.appendChild(script);
          });
        }

        function createAFrameScene() {
          // Create A-Frame scene element
          const scene = document.createElement('a-scene');
          scene.setAttribute('vr-mode-ui', 'enabled: true');

          // Add passthrough setup
          const passthrough = document.createElement('a-entity');
          passthrough.setAttribute(
            'webxr-passthrough',
            'referenceSpaceType: local-floor',
          );
          scene.appendChild(passthrough);

          // Add left controller
          const leftHand = document.createElement('a-entity');
          leftHand.id = 'leftHand';
          leftHand.setAttribute('oculus-touch-controls', 'hand: left');

          const leftHandInfo = document.createElement('a-text');
          leftHandInfo.id = 'leftHandInfo';
          leftHandInfo.setAttribute('value', 'Pos: ...\\nRot: ...');
          leftHandInfo.setAttribute('position', '0 0.04 -0.05');
          leftHandInfo.setAttribute('rotation', '0 0 0');
          leftHandInfo.setAttribute('scale', '0.05 0.05 0.05');
          leftHandInfo.setAttribute('color', 'white');
          leftHandInfo.setAttribute('align', 'center');
          leftHand.appendChild(leftHandInfo);
          scene.appendChild(leftHand);

          // Add right controller
          const rightHand = document.createElement('a-entity');
          rightHand.id = 'rightHand';
          rightHand.setAttribute('oculus-touch-controls', 'hand: right');

          const rightHandInfo = document.createElement('a-text');
          rightHandInfo.id = 'rightHandInfo';
          rightHandInfo.setAttribute('value', 'Pos: ...\\nRot: ...');
          rightHandInfo.setAttribute('position', '0 0.04 -0.05');
          rightHandInfo.setAttribute('rotation', '0 0 0');
          rightHandInfo.setAttribute('scale', '0.05 0.05 0.05');
          rightHandInfo.setAttribute('color', 'white');
          rightHandInfo.setAttribute('align', 'center');
          rightHand.appendChild(rightHandInfo);
          scene.appendChild(rightHand);

          // Add video stream display
          const videoEntity = document.createElement('a-entity');
          videoEntity.setAttribute(
            'teleop-video-stream',
            'roomName: robot-vr-room; participantIdentity: vr-viewer',
          );

          const rightVideoPlane = document.createElement('a-plane');
          rightVideoPlane.id = 'rightVideoPlane';
          rightVideoPlane.setAttribute('position', '0 1.6 -2');
          rightVideoPlane.setAttribute('width', '2');
          rightVideoPlane.setAttribute('height', '1.5');
          rightVideoPlane.setAttribute('stereo', 'eye: right');
          videoEntity.appendChild(rightVideoPlane);

          const leftVideoPlane = document.createElement('a-plane');
          leftVideoPlane.id = 'leftVideoPlane';
          leftVideoPlane.setAttribute('position', '0 1.6 -2');
          leftVideoPlane.setAttribute('width', '2');
          leftVideoPlane.setAttribute('height', '1.5');
          leftVideoPlane.setAttribute('stereo', 'eye: left');
          videoEntity.appendChild(leftVideoPlane);

          scene.appendChild(videoEntity);

          // Add scene to document
          document.body.appendChild(scene);
        }

        function waitForSceneReady(sceneEl) {
          return new Promise((resolve, reject) => {
            if (sceneEl.hasLoaded) {
              resolve();
            } else {
              sceneEl.addEventListener('loaded', () => resolve(), {
                once: true,
              });

              // Timeout after 10 seconds
              setTimeout(
                () => reject(new Error('Scene loading timeout')),
                10000,
              );
            }
          });
        }
      });
    </script>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <!-- Desktop Instructions Interface (hidden in VR) -->
    <div class="desktop-interface" id="desktopInterface">
      <div class="desktop-header">
        <div class="desktop-title">
          Tactile Robotics - VR Remote Teleoperation
        </div>
        <div class="desktop-subtitle">Immersive Robot Control Experience</div>

        <!-- Back to Main Site Button -->
        <button class="back-button" onclick="window.location.href='index.html'">
          ‚Üê Back to Main
        </button>

        <!-- Robot Status Section -->
        <div class="status-section" id="statusSection">
          <h2>ü§ñ Robot Status</h2>
          <div class="status-grid">
            <div class="status-item">
              <div class="status-indicator" id="leftArmStatus"></div>
              <span>Left Arm</span>
            </div>
            <div class="status-item">
              <div class="status-indicator" id="rightArmStatus"></div>
              <span>Right Arm</span>
            </div>
            <div class="status-item">
              <div class="status-indicator" id="vrStatus"></div>
              <span>VR Connected</span>
            </div>
          </div>
        </div>

        <!-- VR Instructions Section -->
        <div class="vr-instructions-section" id="vrInstructionsSection">
          <h2>ü•Ω VR Remote Teleoperation Instructions</h2>
          <div class="instructions-content">
            <div class="instructions-image">
              <img
                src="media/telegrip_instructions.jpg"
                alt="VR Controller Instructions"
                style="
                  max-width: 100%;
                  height: auto;
                  border-radius: 8px;
                  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                "
              />
            </div>
            <div class="instructions-text">
              <div class="instruction-item">
                <strong>Setup:</strong> Open this same page
                <span
                  id="vrServerUrl"
                  style="
                    font-family: monospace;
                    background: rgba(255, 255, 255, 0.2);
                    padding: 2px 6px;
                    border-radius: 4px;
                  "
                  >Loading...</span
                >
                in your VR headset's browser and click "Start Controller
                Tracking"
              </div>
              <div class="instruction-item">
                <strong>Grip Button:</strong> The robot arm's gripper tip will
                track your relative controller movements as long as you hold the
                grip button
              </div>
              <div class="instruction-item">
                <strong>Controller Orientation:</strong> Roll and pitch of your
                controller will be matched on the wrist joint of the robot arm
              </div>
              <div class="instruction-item">
                <strong>Trigger Button:</strong> The gripper stays closed while
                you hold the trigger button. Release the trigger button to open
                the gripper.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Demo booking button (bottom left) -->
    <div class="demo-booking-button" id="demoBookingButton">
      <button onclick="window.location.href='index.html#booking'">
        Book a demo
      </button>
    </div>

    <!-- A-Frame VR Scene will be created dynamically after VR button is clicked -->
  </body>
</html>
